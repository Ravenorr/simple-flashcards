<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Flashcards & Sch√©mas</title>

    <link rel="icon"
          href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìö</text></svg>">

    <link rel="stylesheet" href="style.css">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script>
        window.MathJax = {
            tex: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

<h1>üß† R√©visions</h1>

<div class="tabs-container">
    <button class="tab-btn active" data-mode="flashcards">üìù Flashcards</button>
    <button class="tab-btn" data-mode="schemas">üñºÔ∏è Sch√©mas</button>
    <button class="tab-btn" data-mode="quiz">‚ùì Quiz</button>
</div>

<div class="controls-wrapper">

    <h2 class="section-title"><span id="libraryTitle">Biblioth√®que</span></h2>

    <div class="select-group">
        <select id="categorySelect">
            <option value="" disabled selected>‚è≥ Chargement...</option>
        </select>
        <select id="fileSelect" disabled>
            <option value="" disabled selected>üìÑ Sujet</option>
        </select>
        <button id="loadBtn" class="load-btn">Charger</button>
    </div>

    <!-- Container pour l'upload local -->
    <div id="localFileSection">
        <div style="width: 100%; text-align: center; margin: 15px 0 10px 0; color: #b2bec3; font-size: 0.8rem;">
            ‚Äî ou ‚Äî
        </div>

        <div style="text-align: center;">
            <label for="csvFileInput" class="custom-file-upload">
                üìÇ Ouvrir un fichier local (.csv)
            </label>
            <input type="file" id="csvFileInput" accept=".csv"/>
        </div>
    </div>

    <h2 class="section-title"><span>Options</span></h2>

    <div id="optionsButtonsContainer" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;">
        <button id="flipAllBtn" class="action-btn" style="background-color: #a29bfe;">üîÑ Tout retourner</button>
        <button id="filterBtn" class="action-btn">üëÅÔ∏è Cacher les acquis (5/5)</button>
        <button id="resetSaveBtn" class="action-btn"
                style="background-color: #fab1a0; color: #d63031; font-size: 0.8rem;">üóëÔ∏è Reset ce sujet
        </button>

        <button id="resetQuizBtn" class="action-btn"
                style="background-color: #ff7675; color: white; display: none;">üîÑ Recommencer le Quiz</button>
    </div>

</div>

<div id="cards-container"></div>

<script>
    // Structure de donn√©es globale
    let GLOBAL_DATA = {};
    let currentMode = 'flashcards'; // 'flashcards' ou 'schemas' ou 'quiz'

    let savedData = JSON.parse(localStorage.getItem('flashcards_data') || '{}');
    let currentFileName = "";
    let currentQuizData = null; // Pour stocker les donn√©es du quiz actuel

    // DOM Elements
    const categorySelect = document.getElementById('categorySelect');
    const fileSelect = document.getElementById('fileSelect');
    const loadBtn = document.getElementById('loadBtn');
    const fileInput = document.getElementById('csvFileInput');
    const container = document.getElementById('cards-container');
    const tabBtns = document.querySelectorAll('.tab-btn');
    const localFileSection = document.getElementById('localFileSection');
    const optionsButtonsContainer = document.getElementById('optionsButtonsContainer');

    const flipAllBtn = document.getElementById('flipAllBtn');
    const filterBtn = document.getElementById('filterBtn');
    const resetBtn = document.getElementById('resetSaveBtn');
    const resetQuizBtn = document.getElementById('resetQuizBtn');

    let isFilterActive = false;

    // --- 1. CONFIGURATION & NAVIGATION ---
    fetch('config.json?t=' + new Date().getTime())
        .then(res => res.ok ? res.json() : Promise.reject())
        .then(data => {
            GLOBAL_DATA = data;
            updateMenuForMode();
        })
        .catch(() => categorySelect.innerHTML = '<option disabled>Erreur config</option>');

    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            tabBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            currentMode = btn.dataset.mode;
            updateOptionsVisibility();

            if (currentMode === 'flashcards') {
                localFileSection.style.display = 'block';
            } else {
                localFileSection.style.display = 'none';
            }

            container.innerHTML = '';
            currentFileName = "";
            currentQuizData = null;

            updateMenuForMode();
        });
    });

    function updateOptionsVisibility() {
        if (currentMode === 'quiz') {
            optionsButtonsContainer.style.display = 'flex';
            flipAllBtn.style.display = 'none';
            filterBtn.style.display = 'none';
            resetBtn.style.display = 'none';
            resetQuizBtn.style.display = 'block';
        } else {
            optionsButtonsContainer.style.display = 'flex';
            flipAllBtn.style.display = 'block';
            filterBtn.style.display = 'block';
            resetBtn.style.display = 'block';
            resetQuizBtn.style.display = 'none';
        }
    }

    function updateMenuForMode() {
        const modeData = GLOBAL_DATA[currentMode];

        categorySelect.innerHTML = '<option value="" disabled selected>üìÅ Dossier</option>';
        fileSelect.innerHTML = '<option value="" disabled selected>üìÑ Sujet</option>';
        fileSelect.disabled = true;

        if (modeData) {
            Object.keys(modeData).forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.textContent = cat;
                categorySelect.appendChild(opt);
            });
        } else {
            categorySelect.innerHTML = '<option disabled>Aucune donn√©e</option>';
        }
    }

    categorySelect.addEventListener('change', () => {
        const modeData = GLOBAL_DATA[currentMode];
        fileSelect.innerHTML = '<option value="" disabled selected>üìÑ Sujet</option>';
        fileSelect.disabled = false;

        if (modeData && modeData[categorySelect.value]) {
            modeData[categorySelect.value].forEach(f => {
                const opt = document.createElement('option');
                opt.value = f;
                opt.textContent = f.replace('.csv', '').replace('.json', '').replace(/_/g, ' ');
                fileSelect.appendChild(opt);
            });
        }
    });

    // --- 2. CHARGEMENT ---
    loadBtn.addEventListener('click', () => {
        if (categorySelect.value && fileSelect.value) {
            currentFileName = fileSelect.value;
            if (currentMode === 'quiz') {
                const filePath = `datas/${encodeURIComponent(categorySelect.value)}/quiz/${encodeURIComponent(fileSelect.value)}`;
                fetch(filePath)
                    .then(r => r.json())
                    .then(json => {
                        currentQuizData = json.quiz; // Stocke les donn√©es
                        generateQuiz(currentQuizData);
                    })
                    .catch(() => {
                        container.innerHTML = '<p style="text-align:center; width:100%;">Erreur chargement quiz.</p>';
                    });
            } else {
                const filePath = `datas/${encodeURIComponent(categorySelect.value)}/${currentMode}/${encodeURIComponent(fileSelect.value)}`;
                Papa.parse(filePath, {
                    download: true,
                    complete: res => {
                        // Check if response is HTML (SPA 404 fallback)
                        if (res.data && res.data.length > 0 && typeof res.data[0][0] === 'string' && res.data[0][0].trim().startsWith('<!DOCTYPE')) {
                            alert("Fichier introuvable (404). V√©rifiez le nom du fichier.");
                            return;
                        }
                        generateCards(res.data);

                        // Scroll automatique vers la section Options
                        const optionsTitle = document.querySelectorAll('.section-title')[1]; // Le deuxiÔøΩÔøΩme titre est "Options"
                        if (optionsTitle) {
                            optionsTitle.scrollIntoView({behavior: 'smooth', block: 'start'});
                        }
                    },
                    error: () => alert("Erreur chargement"),
                    header: false, skipEmptyLines: true
                });
            }
        } else alert("S√©lectionnez un sujet.");
    });

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            currentFileName = file.name;
            Papa.parse(file, {complete: res => generateCards(res.data), header: false, skipEmptyLines: true});
        }
    });

    // --- 3. SAUVEGARDE & RESET ---
    function saveScore(key, score) {
        if (!savedData[currentFileName]) {
            savedData[currentFileName] = {};
        }
        savedData[currentFileName][key] = score;
        localStorage.setItem('flashcards_data', JSON.stringify(savedData));
    }

    resetBtn.addEventListener('click', () => {
        if (!currentFileName) {
            alert("Aucun sujet n'est charg√© actuellement.");
            return;
        }
        if (confirm(`Supprimer la progression pour le sujet en cours ?`)) {
            if (savedData[currentFileName]) delete savedData[currentFileName];
            localStorage.setItem('flashcards_data', JSON.stringify(savedData));

            // Refresh visuel
            const currentCards = document.querySelectorAll('.card');
            currentCards.forEach(c => {
                c.className = 'card';
                c.dataset.score = 0;
            });
            document.querySelectorAll('.rate-btn').forEach(b => b.classList.remove('selected'));
            if (isFilterActive) applyFilterAndSort();
        }
    });

    resetQuizBtn.addEventListener('click', () => {
        if (currentQuizData && currentQuizData.length > 0) {
            if (confirm("Voulez-vous recommencer ce quiz √† z√©ro ?")) {
                generateQuiz(currentQuizData);
            }
        }
    });

    // --- ADMIN BUTTON ---
    const adminBtn = document.createElement('button');
    adminBtn.textContent = '‚öôÔ∏è Config';
    adminBtn.style.cssText = 'position:fixed; bottom:10px; right:10px; opacity:0.5; font-size:0.8rem; background:#2d3436; color:white; border:none; padding:5px 10px; border-radius:15px; cursor:pointer; z-index:9999;';
    document.body.appendChild(adminBtn);

    adminBtn.addEventListener('click', () => {
        const password = prompt("üîê Mot de passe config :");
        if (password === "Config123!") {
            sessionStorage.setItem('isAdmin', 'true');
            window.location.href = 'admin.html';
        } else if (password !== null) {
            alert("‚ùå Mot de passe incorrect");
        }
    });

    // --- SCROLL TO TOP BUTTON ---
    const scrollTopBtn = document.createElement('button');
    scrollTopBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>';
    scrollTopBtn.className = 'scroll-top-btn';
    document.body.appendChild(scrollTopBtn);

    window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
            scrollTopBtn.classList.add('visible');
        } else {
            scrollTopBtn.classList.remove('visible');
        }
    });

    scrollTopBtn.addEventListener('click', () => {
        window.scrollTo({top: 0, behavior: 'smooth'});
    });

    // --- 4. BOUTONS ACTION ---
    flipAllBtn.addEventListener('click', () => {
        // Retourne toutes les cartes classiques
        document.querySelectorAll('.card.is-flipped').forEach(c => c.classList.remove('is-flipped'));

        // R√©initialise tous les masques interactifs (Sch√©mas)
        document.querySelectorAll('.schema-mask.revealed').forEach(m => m.classList.remove('revealed'));
    });

    filterBtn.addEventListener('click', () => {
        isFilterActive = !isFilterActive;
        if (isFilterActive) {
            filterBtn.classList.add('active');
            filterBtn.textContent = "‚ùå Tout afficher";
            applyFilterAndSort();
        } else {
            filterBtn.classList.remove('active');
            filterBtn.textContent = "üëÅÔ∏è Cacher les acquis (5/5)";
            resetFilterAndSort();
        }
    });

    function applyFilterAndSort() {
        const scenes = document.querySelectorAll('.scene');
        scenes.forEach(scene => {
            const card = scene.querySelector('.card');
            const score = parseInt(card.dataset.score) || 0;
            if (score === 5) scene.style.display = 'none';
            else scene.style.display = 'block';

            scene.style.order = (score > 0) ? score : 10;
        });
    }

    function resetFilterAndSort() {
        document.querySelectorAll('.scene').forEach(s => {
            s.style.display = 'block';
            s.style.order = 10;
        });
    }

    // --- 5. GENERATION DES CARTES ---
    function generateCards(data) {
        container.innerHTML = '';
        isFilterActive = false;
        filterBtn.classList.remove('active');
        filterBtn.textContent = "üëÅÔ∏è Cacher les acquis (5/5)";
        container.classList.remove('mode-quiz');

        // Toggle container mode class
        if (currentMode === 'schemas') {
            container.classList.add('mode-schemas');
        } else {
            container.classList.remove('mode-schemas');
        }

        // On filtre les lignes vides
        const validData = data.filter(row => row.length >= 2);

        if (validData.length === 0) {
            container.innerHTML = '<p style="text-align:center; width:100%;">Fichier vide ou format incorrect.</p>';
            return;
        }

        validData.forEach((row, index) => {
            // Cl√© unique pour la sauvegarde (Titre ou Question)
            const uniqueKey = row[0];

            let savedScore = 0;
            if (savedData[currentFileName] && savedData[currentFileName][uniqueKey]) {
                savedScore = savedData[currentFileName][uniqueKey];
            }

            // Boutons notation (Pr√©-g√©n√©r√©s pour √™tre utilis√©s flexiblement)
            let buttonsHtml = '<div class="rating-container">';
            for (let i = 1; i <= 5; i++) {
                const isSelected = (i === savedScore) ? 'selected' : '';
                buttonsHtml += `<button class="rate-btn ${isSelected}" data-score="${i}">${i}</button>`;
            }
            buttonsHtml += '</div>';

            const scene = document.createElement('div');
            scene.className = 'scene';

            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.score = savedScore;
            if (savedScore > 0) card.classList.add(`rate-${savedScore}`);

            const counterText = `${index + 1} / ${validData.length}`;

            // --- LOGIQUE D'AFFICHAGE SELON LE MODE ---
            let frontContent = '';
            let backContentHtml = '';
            let isInteractive = false; // Flag pour savoir si schema interactif

            if (currentMode === 'flashcards') {
                // MODE TEXTE CLASSIQUE
                const question = row[0];
                const answer = row[1];

                frontContent = `
                        <div>${question}</div>
                        <span class="card-counter">${counterText}</span>
                    `;

                backContentHtml = `
                    <div class="back-content">
                        <div class="mini-question">${question}</div>
                        <div class="answer-text">${answer}</div>
                    </div>
                    ${buttonsHtml}
                    <span class="card-counter">${counterText}</span>
                    `;

            } else if (currentMode === 'schemas') {
                // MODE IMAGE
                const title = row[0];
                const imgQuestion = row[1] ? row[1].trim() : '';
                const imgAnswer = row[2] ? row[2].trim() : '';
                const jsonCoordsFile = row[3] ? row[3].trim() : null;

                const cardId = 'schema-' + index;

                if (jsonCoordsFile) {
                    isInteractive = true;
                    // --- MODE INTERACTIF ---
                    // Tout sur le FRONT : Image interactive + Boutons notation

                    frontContent = `
                        <div class="schema-title">${title}</div>
                        <div id="${cardId}-interactive" class="schema-content-wrapper" style="width:100%; min-height:100px;">
                             <p style="text-align:center; color:#b2bec3; padding:20px;">Chargement du sch√©ma interactif...</p>
                        </div>
                        <br>
                        ${buttonsHtml}
                        <span class="card-counter">${counterText}</span>
                    `;

                    // Chargement JSON
                    fetch(`datas/${categorySelect.value}/schemas/${jsonCoordsFile}`)
                        .then(r => r.json())
                        .then(coords => {
                            const wrapper = document.getElementById(`${cardId}-interactive`);
                            if (!wrapper) return;

                            let masksHtml = '';
                            coords.forEach(c => {
                                masksHtml += `<div class="schema-mask" style="left:${c.x}%; top:${c.y}%; width:${c.w}%; height:${c.h}%;" onclick="this.classList.add('revealed'); event.stopPropagation();"></div>`;
                            });

                            wrapper.innerHTML = `
                                <div class="interactive-container">
                                    <img src="datas/${categorySelect.value}/schemas/${imgAnswer}" alt="Sch√©ma Interactif" style="width:100%; display:block;">
                                    ${masksHtml}
                                </div>
                            `;
                        })
                        .catch(err => {
                            const wrapper = document.getElementById(`${cardId}-interactive`);
                            if (wrapper) wrapper.innerHTML = `<div style="color:red">Erreur chargement coordonnees</div>`;
                        });

                } else {
                    // --- MODE CLASSIQUE ---
                    frontContent = `
                        <div class="schema-title">${title}</div>
                        <img src="datas/${categorySelect.value}/schemas/${imgQuestion}" class="card-image" alt="Question" onerror="this.style.display='none'; this.parentNode.innerHTML+='<br><small>Image introuvable</small>'">
                        <span class="card-counter">${counterText}</span>
                    `;

                    backContentHtml = `
                    <div class="back-content">
                        <div class="schema-title">${title}</div>
                        <img src="datas/${categorySelect.value}/schemas/${imgAnswer}" class="card-image" alt="R√©ponse" onerror="this.style.display='none'; this.parentNode.innerHTML+='<br><small>Image introuvable</small>'">
                    </div>
                    ${buttonsHtml}
                    <span class="card-counter">${counterText}</span>
                    `;
                }
            }

            // Construction HTML
            const front = document.createElement('div');
            front.className = 'card__face card__face--front';
            front.innerHTML = frontContent;
            card.appendChild(front);

            // Back face seulement si pas interactif
            if (!isInteractive) {
                const back = document.createElement('div');
                back.className = 'card__face card__face--back';
                back.innerHTML = backContentHtml;
                card.appendChild(back);
            }

            scene.appendChild(card);
            container.appendChild(scene);

            // Events
            // On ne flip que si NON interactif
            if (!isInteractive) {
                scene.addEventListener('click', (e) => {
                    if (e.target.classList.contains('rate-btn')) return;
                    card.classList.toggle('is-flipped');
                });
            } else {
                scene.style.cursor = 'default';
            }

            // Gestion des boutons (front ou back)
            card.querySelectorAll('.rate-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const score = parseInt(btn.dataset.score);

                    saveScore(uniqueKey, score);

                    card.dataset.score = score;
                    // On nettoie les anciennes classes rate-
                    card.classList.remove('rate-1', 'rate-2', 'rate-3', 'rate-4', 'rate-5');
                    card.classList.add(`rate-${score}`);

                    if (!isInteractive) {
                        card.classList.add('is-flipped');
                    }

                    // Reset selection visuelle
                    card.querySelectorAll('.rate-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');

                    if (isFilterActive) applyFilterAndSort();
                });
            });
        });

        if (window.MathJax) MathJax.typesetPromise();
    }

    // --- 5. GENERATION DU QUIZ ---
    function generateQuiz(originalQuizData) {
        container.innerHTML = '';
        container.classList.remove('mode-schemas');
        container.classList.add('mode-quiz');

        if (!originalQuizData || !Array.isArray(originalQuizData) || originalQuizData.length === 0) {
            container.innerHTML = '<p style="text-align:center; width:100%;">Aucune question dans ce quiz.</p>';
            return;
        }

        const quizData = JSON.parse(JSON.stringify(originalQuizData));

        quizData.forEach(q => {
            if (q.answerOptions && Array.isArray(q.answerOptions)) {
                for (let i = q.answerOptions.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [q.answerOptions[i], q.answerOptions[j]] = [q.answerOptions[j], q.answerOptions[i]];
                }
            }
        });

        let currentIndex = 0;
        let completedQuestions = new Array(quizData.length).fill(false);
        let firstAttempts = new Array(quizData.length).fill(true); // Pour le score
        let score = 0;

        function renderQuestion(idx) {
            const q = quizData[idx];
            if (!q) return;

            const isNextDisabled = (idx === quizData.length - 1);

            const hintHtml = q.hint
                ? `<div class="quiz-hint-wrapper">
                     <button class="quiz-show-hint-btn">üí° Voir l'indice</button>
                     <div class="quiz-hint-text" style="display:none;">${q.hint}</div>
                   </div>`
                : '';

            container.innerHTML = `
                <div class="quiz-question-block">
                    <div class="quiz-progress">${idx + 1} / ${quizData.length}</div>
                    <div class="quiz-question">${q.question}</div>

                    ${hintHtml}

                    <div class="quiz-answers">
                        ${q.answerOptions.map((opt, i) => `
                            <button class="quiz-answer-btn" data-idx="${i}">
                                <span class="answer-text">${opt.text}</span>
                                <span class="quiz-answer-feedback" id="feedback-${i}" style="display:none;"></span>
                            </button>
                        `).join('')}
                    </div>
                    <div class="quiz-nav">
                        <button class="quiz-prev-btn" ${idx === 0 ? 'disabled' : ''}>Pr√©c√©dent</button>
                        <button class="quiz-next-btn" ${isNextDisabled ? 'disabled' : ''}>Suivant</button>
                    </div>
                    <div class="quiz-global-feedback"></div>
                </div>
            `;

            const hintBtn = container.querySelector('.quiz-show-hint-btn');
            if (hintBtn) {
                hintBtn.addEventListener('click', () => {
                    const hintText = container.querySelector('.quiz-hint-text');
                    hintText.style.display = 'block';
                    hintBtn.style.display = 'none';
                });
            }

            if (completedQuestions[idx]) {
                const correctIdx = q.answerOptions.findIndex(o => o.isCorrect);
                if (correctIdx !== -1) {
                    showFeedback(idx, correctIdx, true); // true = restoration mode
                }
            }

            document.querySelectorAll('.quiz-answer-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const answerIdx = parseInt(btn.dataset.idx);
                    handleAnswerClick(idx, answerIdx, btn);
                });
            });

            document.querySelector('.quiz-prev-btn').onclick = () => {
                if (currentIndex > 0) {
                    currentIndex--;
                    renderQuestion(currentIndex);
                }
            };
            document.querySelector('.quiz-next-btn').onclick = () => {
                if (currentIndex < quizData.length - 1) {
                    currentIndex++;
                    renderQuestion(currentIndex);
                }
            };

            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }

        function handleAnswerClick(idx, answerIdx, btnElement) {
            const q = quizData[idx];
            const isCorrect = q.answerOptions[answerIdx].isCorrect;

            const feedbackEl = btnElement.querySelector(`#feedback-${answerIdx}`);

            if (feedbackEl) {
                feedbackEl.style.display = 'block';
                feedbackEl.innerHTML = `
                    <span class="quiz-feedback-divider"></span>
                    <span class="quiz-feedback-msg">
                        ${isCorrect ? '‚úÖ Bonne r√©ponse !' : '‚ùå Mauvaise r√©ponse.'}
                    </span>
                    <span class="quiz-rationale">${q.answerOptions[answerIdx].rationale || ''}</span>
                `;
                if (window.MathJax) {
                    MathJax.typesetPromise([feedbackEl]);
                }
            }

            btnElement.classList.remove('correct', 'incorrect');

            if (isCorrect) {
                 btnElement.classList.add('correct');
                 btnElement.style.background = '#00b894';
                 btnElement.style.color = '#fff';
                 btnElement.style.borderColor = '#00b894';

                completedQuestions[idx] = true;

                if (firstAttempts[idx]) {
                    score++;
                }

                if (idx === quizData.length - 1) {
                    showFinalScore(idx);
                }

            } else {
                btnElement.classList.add('incorrect');
                btnElement.style.background = '#ffeaa7';
                btnElement.style.borderColor = '#d63031';
                btnElement.style.color = '#2d3436';

                const msg = feedbackEl.querySelector('.quiz-feedback-msg');
                if(msg) msg.style.color = '#d63031';

                firstAttempts[idx] = false;
            }
        }

        function showFeedback(idx, answerIdx, isRestoration = false) {
             const q = quizData[idx];
             const btn = container.querySelector(`.quiz-answer-btn[data-idx="${answerIdx}"]`);
             if(!btn) return;

             const feedbackEl = btn.querySelector(`#feedback-${answerIdx}`);
             if (feedbackEl) {
                feedbackEl.style.display = 'block';
                feedbackEl.innerHTML = `
                    <span class="quiz-feedback-divider"></span>
                    <span class="quiz-feedback-msg">‚úÖ Bonne r√©ponse !</span>
                    <span class="quiz-rationale">${q.answerOptions[answerIdx].rationale || ''}</span>
                `;
                if (window.MathJax) {
                    MathJax.typesetPromise([feedbackEl]);
                }
             }

             container.querySelectorAll('.quiz-answer-btn').forEach((b, i) => {
                 b.disabled = true;
                 if (i === answerIdx) {
                     b.classList.add('correct');
                     b.style.background = '#00b894';
                     b.style.color = '#fff';
                     b.style.borderColor = '#00b894';
                 }
             });

             if (idx === quizData.length - 1) {
                 showFinalScore(idx);
             }
        }

        function showFinalScore(idx) {
             const globalFeedback = container.querySelector('.quiz-global-feedback');
             if(globalFeedback) {
                 globalFeedback.innerHTML = `<div class="quiz-final-score" style="margin-top:20px; font-size:1.2rem;">
                    Score final : <b>${score} / ${quizData.length}</b>
                </div>`;
             }
        }

        renderQuestion(currentIndex);
    }
</script>
</body>
</html>

