<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Flashcards & Sch√©mas</title>

    <link rel="icon"
          href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìö</text></svg>">

    <link rel="stylesheet" href="style.css">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script>
        window.MathJax = {
            tex: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

<h1>üß† R√©visions</h1>

<div class="tabs-container">
    <button class="tab-btn active" data-mode="flashcards">üìù Flashcards</button>
    <button class="tab-btn" data-mode="schemas">üñºÔ∏è Sch√©mas</button>
</div>

<div class="controls-wrapper">

    <h2 class="section-title"><span id="libraryTitle">Biblioth√®que</span></h2>

    <div class="select-group">
        <select id="categorySelect">
            <option value="" disabled selected>‚è≥ Chargement...</option>
        </select>
        <select id="fileSelect" disabled>
            <option value="" disabled selected>üìÑ Sujet</option>
        </select>
        <button id="loadBtn" class="load-btn">Charger</button>
    </div>

    <div style="width: 100%; text-align: center; margin: 15px 0 10px 0; color: #b2bec3; font-size: 0.8rem;">
        ‚Äî ou ‚Äî
    </div>

    <div style="text-align: center;">
        <label for="csvFileInput" class="custom-file-upload">
            üìÇ Ouvrir un fichier local (.csv)
        </label>
        <input type="file" id="csvFileInput" accept=".csv"/>
    </div>

    <h2 class="section-title"><span>Options</span></h2>

    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;">
        <button id="flipAllBtn" class="action-btn" style="background-color: #a29bfe;">üîÑ Tout retourner</button>
        <button id="filterBtn" class="action-btn">üëÅÔ∏è Cacher les acquis (5/5)</button>
        <button id="resetSaveBtn" class="action-btn"
                style="background-color: #fab1a0; color: #d63031; font-size: 0.8rem;">üóëÔ∏è Reset ce sujet
        </button>
    </div>

</div>

<div id="cards-container"></div>

<script>
    // Structure de donn√©es globale
    let GLOBAL_DATA = {};
    let currentMode = 'flashcards'; // 'flashcards' ou 'schemas'

    let savedData = JSON.parse(localStorage.getItem('flashcards_data') || '{}');
    let currentFileName = "";

    // DOM Elements
    const categorySelect = document.getElementById('categorySelect');
    const fileSelect = document.getElementById('fileSelect');
    const loadBtn = document.getElementById('loadBtn');
    const fileInput = document.getElementById('csvFileInput');
    const container = document.getElementById('cards-container');
    const tabBtns = document.querySelectorAll('.tab-btn');

    const flipAllBtn = document.getElementById('flipAllBtn');
    const filterBtn = document.getElementById('filterBtn');
    const resetBtn = document.getElementById('resetSaveBtn');

    let isFilterActive = false;

    // --- 1. CONFIGURATION & NAVIGATION ---
    fetch('config.json?t=' + new Date().getTime())
        .then(res => res.ok ? res.json() : Promise.reject())
        .then(data => {
            GLOBAL_DATA = data;
            updateMenuForMode();
        })
        .catch(() => categorySelect.innerHTML = '<option disabled>Erreur config</option>');

    // Gestion des onglets
    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            // Change l'aspect visuel
            tabBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Change le mode logique
            currentMode = btn.dataset.mode;

            // Vide l'interface actuelle
            container.innerHTML = '';
            currentFileName = "";

            // Met √† jour les listes d√©roulantes
            updateMenuForMode();
        });
    });

    function updateMenuForMode() {
        // R√©cup√®re les donn√©es correspondant au mode (flashcards ou schemas)
        const modeData = GLOBAL_DATA[currentMode];

        categorySelect.innerHTML = '<option value="" disabled selected>üìÅ Dossier</option>';
        fileSelect.innerHTML = '<option value="" disabled selected>üìÑ Sujet</option>';
        fileSelect.disabled = true;

        if (modeData) {
            Object.keys(modeData).forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.textContent = cat;
                categorySelect.appendChild(opt);
            });
        } else {
            categorySelect.innerHTML = '<option disabled>Aucune donn√©e</option>';
        }
    }

    categorySelect.addEventListener('change', () => {
        const modeData = GLOBAL_DATA[currentMode];
        fileSelect.innerHTML = '<option value="" disabled selected>üìÑ Sujet</option>';
        fileSelect.disabled = false;

        if (modeData && modeData[categorySelect.value]) {
            modeData[categorySelect.value].forEach(f => {
                const opt = document.createElement('option');
                opt.value = f;
                opt.textContent = f.replace('.csv', '').replace(/_/g, ' ');
                fileSelect.appendChild(opt);
            });
        }
    });

    // --- 2. CHARGEMENT ---
    loadBtn.addEventListener('click', () => {
        if (categorySelect.value && fileSelect.value) {
            currentFileName = fileSelect.value;
            const filePath = `datas/${encodeURIComponent(categorySelect.value)}/${currentMode}/${encodeURIComponent(fileSelect.value)}`;
            // Le chemin d√©pend du dossier cat√©gorie
            Papa.parse(filePath, {
                download: true,
                complete: res => {
                    // Check if response is HTML (SPA 404 fallback)
                    if (res.data && res.data.length > 0 && typeof res.data[0][0] === 'string' && res.data[0][0].trim().startsWith('<!DOCTYPE')) {
                        alert("Fichier introuvable (404). V√©rifiez le nom du fichier.");
                        return;
                    }
                    generateCards(res.data);

                    // Scroll automatique vers la section Options
                    const optionsTitle = document.querySelectorAll('.section-title')[1]; // Le deuxiÔøΩÔøΩme titre est "Options"
                    if (optionsTitle) {
                        optionsTitle.scrollIntoView({behavior: 'smooth', block: 'start'});
                    }
                },
                error: () => alert("Erreur chargement"),
                header: false, skipEmptyLines: true
            });
        } else alert("S√©lectionnez un sujet.");
    });

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            currentFileName = file.name;
            Papa.parse(file, {complete: res => generateCards(res.data), header: false, skipEmptyLines: true});
        }
    });

    // --- 3. SAUVEGARDE & RESET ---
    function saveScore(key, score) {
        if (!savedData[currentFileName]) {
            savedData[currentFileName] = {};
        }
        savedData[currentFileName][key] = score;
        localStorage.setItem('flashcards_data', JSON.stringify(savedData));
    }

    resetBtn.addEventListener('click', () => {
        if (!currentFileName) {
            alert("Aucun sujet n'est charg√© actuellement.");
            return;
        }
        if (confirm(`Supprimer la progression pour le sujet en cours ?`)) {
            if (savedData[currentFileName]) delete savedData[currentFileName];
            localStorage.setItem('flashcards_data', JSON.stringify(savedData));

            // Refresh visuel
            const currentCards = document.querySelectorAll('.card');
            currentCards.forEach(c => {
                c.className = 'card';
                c.dataset.score = 0;
            });
            document.querySelectorAll('.rate-btn').forEach(b => b.classList.remove('selected'));
            if (isFilterActive) applyFilterAndSort();
        }
    });

    // --- ADMIN BUTTON ---
    const adminBtn = document.createElement('button');
    adminBtn.textContent = '‚öôÔ∏è Config';
    adminBtn.style.cssText = 'position:fixed; bottom:10px; right:10px; opacity:0.5; font-size:0.8rem; background:#2d3436; color:white; border:none; padding:5px 10px; border-radius:15px; cursor:pointer; z-index:9999;';
    document.body.appendChild(adminBtn);

    adminBtn.addEventListener('click', () => {
        const password = prompt("üîê Mot de passe config :");
        if (password === "Config123!") {
            sessionStorage.setItem('isAdmin', 'true');
            window.location.href = 'admin.html';
        } else if (password !== null) {
            alert("‚ùå Mot de passe incorrect");
        }
    });

    // --- SCROLL TO TOP BUTTON ---
    const scrollTopBtn = document.createElement('button');
    scrollTopBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>';
    scrollTopBtn.className = 'scroll-top-btn';
    document.body.appendChild(scrollTopBtn);

    window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
            scrollTopBtn.classList.add('visible');
        } else {
            scrollTopBtn.classList.remove('visible');
        }
    });

    scrollTopBtn.addEventListener('click', () => {
        window.scrollTo({top: 0, behavior: 'smooth'});
    });

    // --- 4. BOUTONS ACTION ---
    flipAllBtn.addEventListener('click', () => {
        // Retourne toutes les cartes classiques
        document.querySelectorAll('.card.is-flipped').forEach(c => c.classList.remove('is-flipped'));

        // R√©initialise tous les masques interactifs (Sch√©mas)
        document.querySelectorAll('.schema-mask.revealed').forEach(m => m.classList.remove('revealed'));
    });

    filterBtn.addEventListener('click', () => {
        isFilterActive = !isFilterActive;
        if (isFilterActive) {
            filterBtn.classList.add('active');
            filterBtn.textContent = "‚ùå Tout afficher";
            applyFilterAndSort();
        } else {
            filterBtn.classList.remove('active');
            filterBtn.textContent = "üëÅÔ∏è Cacher les acquis (5/5)";
            resetFilterAndSort();
        }
    });

    function applyFilterAndSort() {
        const scenes = document.querySelectorAll('.scene');
        scenes.forEach(scene => {
            const card = scene.querySelector('.card');
            const score = parseInt(card.dataset.score) || 0;
            if (score === 5) scene.style.display = 'none';
            else scene.style.display = 'block';

            scene.style.order = (score > 0) ? score : 10;
        });
    }

    function resetFilterAndSort() {
        document.querySelectorAll('.scene').forEach(s => {
            s.style.display = 'block';
            s.style.order = 10;
        });
    }

    // --- 5. GENERATION DES CARTES ---
    function generateCards(data) {
        container.innerHTML = '';
        isFilterActive = false;
        filterBtn.classList.remove('active');
        filterBtn.textContent = "üëÅÔ∏è Cacher les acquis (5/5)";

        // Toggle container mode class
        if (currentMode === 'schemas') {
            container.classList.add('mode-schemas');
        } else {
            container.classList.remove('mode-schemas');
        }

        // On filtre les lignes vides
        const validData = data.filter(row => row.length >= 2);

        if (validData.length === 0) {
            container.innerHTML = '<p style="text-align:center; width:100%;">Fichier vide ou format incorrect.</p>';
            return;
        }

        validData.forEach((row, index) => {
            // Cl√© unique pour la sauvegarde (Titre ou Question)
            const uniqueKey = row[0];

            let savedScore = 0;
            if (savedData[currentFileName] && savedData[currentFileName][uniqueKey]) {
                savedScore = savedData[currentFileName][uniqueKey];
            }

            // Boutons notation (Pr√©-g√©n√©r√©s pour √™tre utilis√©s flexiblement)
            let buttonsHtml = '<div class="rating-container">';
            for (let i = 1; i <= 5; i++) {
                const isSelected = (i === savedScore) ? 'selected' : '';
                buttonsHtml += `<button class="rate-btn ${isSelected}" data-score="${i}">${i}</button>`;
            }
            buttonsHtml += '</div>';

            const scene = document.createElement('div');
            scene.className = 'scene';

            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.score = savedScore;
            if (savedScore > 0) card.classList.add(`rate-${savedScore}`);

            const counterText = `${index + 1} / ${validData.length}`;

            // --- LOGIQUE D'AFFICHAGE SELON LE MODE ---
            let frontContent = '';
            let backContentHtml = '';
            let isInteractive = false; // Flag pour savoir si schema interactif

            if (currentMode === 'flashcards') {
                // MODE TEXTE CLASSIQUE
                const question = row[0];
                const answer = row[1];

                frontContent = `
                        <div>${question}</div>
                        <span class="card-counter">${counterText}</span>
                    `;

                backContentHtml = `
                    <div class="back-content">
                        <div class="mini-question">${question}</div>
                        <div class="answer-text">${answer}</div>
                    </div>
                    ${buttonsHtml}
                    <span class="card-counter">${counterText}</span>
                    `;

            } else if (currentMode === 'schemas') {
                // MODE IMAGE
                const title = row[0];
                const imgQuestion = row[1] ? row[1].trim() : '';
                const imgAnswer = row[2] ? row[2].trim() : '';
                const jsonCoordsFile = row[3] ? row[3].trim() : null;

                const cardId = 'schema-' + index;

                if (jsonCoordsFile) {
                    isInteractive = true;
                    // --- MODE INTERACTIF ---
                    // Tout sur le FRONT : Image interactive + Boutons notation

                    frontContent = `
                        <div class="schema-title">${title}</div>
                        <div id="${cardId}-interactive" class="schema-content-wrapper" style="width:100%; min-height:100px;">
                             <p style="text-align:center; color:#b2bec3; padding:20px;">Chargement du sch√©ma interactif...</p>
                        </div>
                        <br>
                        ${buttonsHtml}
                        <span class="card-counter">${counterText}</span>
                    `;

                    // Chargement JSON
                    fetch(`datas/${categorySelect.value}/schemas/${jsonCoordsFile}`)
                        .then(r => r.json())
                        .then(coords => {
                            const wrapper = document.getElementById(`${cardId}-interactive`);
                            if (!wrapper) return;

                            let masksHtml = '';
                            coords.forEach(c => {
                                masksHtml += `<div class="schema-mask" style="left:${c.x}%; top:${c.y}%; width:${c.w}%; height:${c.h}%;" onclick="this.classList.add('revealed'); event.stopPropagation();"></div>`;
                            });

                            wrapper.innerHTML = `
                                <div class="interactive-container">
                                    <img src="datas/${categorySelect.value}/schemas/${imgAnswer}" alt="Sch√©ma Interactif" style="width:100%; display:block;">
                                    ${masksHtml}
                                </div>
                            `;
                        })
                        .catch(err => {
                            const wrapper = document.getElementById(`${cardId}-interactive`);
                            if (wrapper) wrapper.innerHTML = `<div style="color:red">Erreur chargement coordonnees</div>`;
                        });

                } else {
                    // --- MODE CLASSIQUE ---
                    frontContent = `
                        <div class="schema-title">${title}</div>
                        <img src="datas/${categorySelect.value}/schemas/${imgQuestion}" class="card-image" alt="Question" onerror="this.style.display='none'; this.parentNode.innerHTML+='<br><small>Image introuvable</small>'">
                        <span class="card-counter">${counterText}</span>
                    `;

                    backContentHtml = `
                    <div class="back-content">
                        <div class="schema-title">${title}</div>
                        <img src="datas/${categorySelect.value}/schemas/${imgAnswer}" class="card-image" alt="R√©ponse" onerror="this.style.display='none'; this.parentNode.innerHTML+='<br><small>Image introuvable</small>'">
                    </div>
                    ${buttonsHtml}
                    <span class="card-counter">${counterText}</span>
                    `;
                }
            }

            // Construction HTML
            const front = document.createElement('div');
            front.className = 'card__face card__face--front';
            front.innerHTML = frontContent;
            card.appendChild(front);

            // Back face seulement si pas interactif
            if (!isInteractive) {
                const back = document.createElement('div');
                back.className = 'card__face card__face--back';
                back.innerHTML = backContentHtml;
                card.appendChild(back);
            }

            scene.appendChild(card);
            container.appendChild(scene);

            // Events
            // On ne flip que si NON interactif
            if (!isInteractive) {
                scene.addEventListener('click', (e) => {
                    if (e.target.classList.contains('rate-btn')) return;
                    card.classList.toggle('is-flipped');
                });
            } else {
                scene.style.cursor = 'default';
            }

            // Gestion des boutons (front ou back)
            card.querySelectorAll('.rate-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const score = parseInt(btn.dataset.score);

                    saveScore(uniqueKey, score);

                    card.dataset.score = score;
                    // On nettoie les anciennes classes rate-
                    card.classList.remove('rate-1', 'rate-2', 'rate-3', 'rate-4', 'rate-5');
                    card.classList.add(`rate-${score}`);

                    if (!isInteractive) {
                        card.classList.add('is-flipped');
                    }

                    // Reset selection visuelle
                    card.querySelectorAll('.rate-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');

                    if (isFilterActive) applyFilterAndSort();
                });
            });
        });

        if (window.MathJax) MathJax.typesetPromise();
    }
</script>
</body>
</html>

